<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tablero Kanban</title>

  <style>
    body { font-family: Arial; margin: 20px; }
    .board { display: flex; gap: 20px; }
    .column { flex: 1; border: 1px solid #ccc; border-radius: 6px; padding: 10px; }
    .task { background: #f2f2f2; padding: 8px; margin-bottom: 8px; border-radius: 4px; }
    button { font-size: 12px; margin: 2px; }
    input { margin: 3px 0; width: 90%; }
  </style>
</head>

<body>

<h1>ðŸ“‹ Tablero Kanban</h1>

<form id="task-form">
  <input type="text" id="task-title" placeholder="TÃ­tulo de la tarea">
  <input type="number" id="task-estimated" placeholder="Tiempo estimado (min)">
  <button type="submit">Crear tarea</button>
</form>

<br>

<div class="board">

  <div class="column" id="backlog">
    <h2>Backlog</h2>
    <div class="tasks"></div>
  </div>

  <div class="column" id="doing">
    <h2>Doing (mÃ¡x 4) â€“ Estimado total: <span id="doing-time">0</span> min</h2>
    <div class="tasks"></div>
  </div>

  <div class="column" id="done">
    <h2>Done â€“ Tiempo real</h2>
    <div class="tasks"></div>
  </div>

</div>

<script>
const API = "http://127.0.0.1:5000";

async function loadTasks() {
  const res = await fetch(`${API}/tasks`);
  const tasks = await res.json();
  render(tasks);
}

function render(tasks) {
  document.querySelectorAll(".tasks").forEach(c => c.innerHTML = "");
  let doingTotal = 0;

  tasks.forEach(task => {
    if (task.status === "doing") doingTotal += task.estimated;

    const div = document.createElement("div");
    div.className = "task";

    if (task.status === "done") {
      div.innerHTML = `
        <strong>${task.title}</strong><br>
        Estimado: ${task.estimated} min<br>
        Real:
        <input type="number" value="${task.real}"
          onchange="setReal(${task.id}, this.value)">
      `;
    } else {
      div.innerHTML = `
        <strong>${task.title}</strong><br>
        Estimado: ${task.estimated} min<br>
        <button onclick="moveTask(${task.id}, 'backlog')">Backlog</button>
        <button onclick="moveTask(${task.id}, 'doing')">Doing</button>
        <button onclick="moveTask(${task.id}, 'done')">Done</button>
      `;
    }

    document.querySelector(`#${task.status} .tasks`).appendChild(div);
  });

  document.getElementById("doing-time").textContent = doingTotal;
}

async function moveTask(id, status) {
  const res = await fetch(`${API}/tasks/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status })
  });

  if (!res.ok) {
    const error = await res.json();
    alert(error.error);
    return;
  }

  loadTasks();
}

async function setReal(id, value) {
  await fetch(`${API}/tasks/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ real: parseInt(value) || 0 })
  });
}

document.getElementById("task-form").addEventListener("submit", async e => {
  e.preventDefault();

  const title = task-title.value.trim();
  const estimated = parseInt(task-estimated.value) || 0;

  if (!title) return alert("TÃ­tulo obligatorio");

  await fetch(`${API}/tasks`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, estimated })
  });

  task-title.value = "";
  task-estimated.value = "";
  loadTasks();
});

loadTasks();
</script>

</body>
</html>
