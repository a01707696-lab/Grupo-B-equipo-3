<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tablero Kanban</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    
    /* Instrucciones arriba de las estad√≠sticas */
    .instructions-bar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .instruction-item {
      text-align: center;
      padding: 0 10px;
      border-right: 1px solid rgba(255,255,255,0.2);
    }
    
    .instruction-item:last-child {
      border-right: none;
    }
    
    .instruction-icon {
      font-size: 1.5em;
      margin-bottom: 5px;
      display: block;
    }
    
    .instruction-text {
      font-size: 0.9em;
    }
    
    /* Estad√≠sticas debajo de instrucciones */
    .stats-bar {
      display: flex;
      justify-content: space-around;
      background: #2d3748;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
    }
    
    .main-content {
      display: flex;
      gap: 20px;
    }
    
    .sidebar {
      width: 300px;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }
    
    .board {
      flex: 1;
      display: flex;
      gap: 15px;
    }
    
    .column {
      flex: 1;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #ddd;
      min-height: 500px;
    }
    
    .column-header {
      text-align: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid;
    }
    
    #backlog .column-header { border-color: #6c757d; }
    #doing .column-header { border-color: #007bff; }
    #done .column-header { border-color: #28a745; }
    
    .task {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
      cursor: grab;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .task:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    
    .task.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    
    .task-title {
      font-weight: bold;
      margin-bottom: 5px;
      cursor: pointer;
    }
    
    .task-title:hover {
      color: #667eea;
    }
    
    .task-title-edit {
      width: 100%;
      padding: 4px;
      margin-bottom: 5px;
    }
    
    .task-info {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .task-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }
    
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-warning { background: #ffc107; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    
    .btn-sm {
      padding: 4px 8px;
      font-size: 0.8em;
    }
    
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      text-align: center;
    }
    
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    
    .user-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      background: #667eea;
      color: white;
      border-radius: 12px;
      font-size: 0.8em;
      margin-top: 5px;
    }
    
    .time-input {
      width: 60px;
      padding: 2px;
      text-align: center;
    }
    
    .drop-zone {
      min-height: 100px;
      transition: background-color 0.2s;
    }
    
    .drop-zone.drag-over {
      background-color: rgba(102, 126, 234, 0.1);
      border: 2px dashed #667eea;
    }
    
    .column .tasks-container {
      min-height: 400px;
    }
    
    .empty-message {
      color: #999;
      text-align: center;
      padding: 20px;
      font-style: italic;
    }
    
    .task-meta {
      font-size: 0.8em;
      color: #888;
      margin-top: 5px;
      display: flex;
      justify-content: space-between;
    }
    
    .users-list-item {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    
    .users-list-item:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .user-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #667eea;
    }
    
    .user-actions {
      display: flex;
      gap: 5px;
    }
    
    .user-name-edit {
      width: 150px;
      padding: 4px;
      border: 1px solid #007bff;
      border-radius: 4px;
    }
    
    .assign-select {
      width: 100%;
      padding: 4px;
      font-size: 0.85em;
      margin-top: 5px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .sidebar-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .sidebar-section h3 {
      margin-top: 0;
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }
    
    .task-count-badge {
      background: #e2e8f0;
      color: #4a5568;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8em;
      margin-left: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üìã Tablero Kanban</h1>
    
    <!-- Barra de instrucciones -->
    <div class="instructions-bar">
      <div class="instruction-item">
        <span class="instruction-icon">üëÜ</span>
        <div class="instruction-text"><strong>Arrastra</strong> tareas<br>entre columnas</div>
      </div>
      <div class="instruction-item">
        <span class="instruction-icon">‚úèÔ∏è</span>
        <div class="instruction-text"><strong>Click en t√≠tulo</strong><br>para editar tarea</div>
      </div>
      <div class="instruction-item">
        <span class="instruction-icon">üë§</span>
        <div class="instruction-text"><strong>Selecciona usuario</strong><br>para asignar tarea</div>
      </div>
      <div class="instruction-item">
        <span class="instruction-icon">‚è±Ô∏è</span>
        <div class="instruction-text"><strong>En "Done"</strong><br>ingresa tiempo real</div>
      </div>
      <div class="instruction-item">
        <span class="instruction-icon">üö´</span>
        <div class="instruction-text"><strong>M√°ximo 4 tareas</strong><br>en "Doing"</div>
      </div>
    </div>
    
    <!-- Barra de estad√≠sticas -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="total-tasks">0</div>
        <div>Total Tareas</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="doing-count">0/4</div>
        <div>En Progreso</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="total-estimated">0</div>
        <div>Min Estimados</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="total-real">0</div>
        <div>Min Reales</div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="sidebar">
        <div class="sidebar-section">
          <h3>üë• Gesti√≥n de Usuarios</h3>
          <input type="text" id="user-name" placeholder="Nombre del usuario">
          <button id="add-user-btn" class="btn-primary">‚ûï Agregar Usuario</button>
          
          <div id="users-list" style="margin-top: 15px;"></div>
        </div>
        
        <div class="sidebar-section">
          <h3>‚ûï Nueva Tarea</h3>
          <input type="text" id="task-title" placeholder="T√≠tulo de la tarea">
          <input type="number" id="task-estimated" placeholder="Tiempo estimado (min)">
          <select id="task-assign">
            <option value="">Sin asignar</option>
          </select>
          <button id="create-task-btn" class="btn-success">‚úÖ Crear Tarea</button>
        </div>
        
        <div id="message" class="message" style="display: none;"></div>
      </div>
      
      <div class="board">
        <div class="column" id="backlog-col">
          <div class="column-header">
            <h2>üì• Backlog</h2>
            <div>Tareas pendientes</div>
          </div>
          <div class="tasks-container drop-zone" id="backlog-tasks"></div>
        </div>
        
        <div class="column" id="doing-col">
          <div class="column-header">
            <h2>‚ö° Doing</h2>
            <div><span id="doing-tasks-count">0</span>/4 tareas ‚Ä¢ <span id="doing-total-time">0</span> min</div>
          </div>
          <div class="tasks-container drop-zone" id="doing-tasks"></div>
        </div>
        
        <div class="column" id="done-col">
          <div class="column-header">
            <h2>‚úÖ Done</h2>
            <div><span id="done-tasks-count">0</span> tareas ‚Ä¢ <span id="done-total-time">0</span> min</div>
          </div>
          <div class="tasks-container drop-zone" id="done-tasks"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para confirmar eliminaci√≥n de usuario -->
  <div id="delete-user-modal" class="modal">
    <div class="modal-content">
      <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
      <p id="delete-user-message">¬øEst√°s seguro de eliminar este usuario?</p>
      <div class="modal-buttons">
        <button id="cancel-delete-btn" class="btn-secondary">Cancelar</button>
        <button id="confirm-delete-btn" class="btn-danger">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    const API = "http://127.0.0.1:5000";
    let users = [];
    let tasks = [];
    let editingTaskId = null;
    let editingUserId = null;
    let draggedTask = null;
    let userToDelete = null;

    // ========== INICIALIZACI√ìN ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Asignar eventos a los botones principales
      document.getElementById('add-user-btn').addEventListener('click', addUser);
      document.getElementById('create-task-btn').addEventListener('click', createTask);
      
      // Eventos del modal
      document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);
      document.getElementById('confirm-delete-btn').addEventListener('click', confirmDeleteUser);
      
      // Cerrar modal al hacer clic fuera
      document.getElementById('delete-user-modal').addEventListener('click', function(e) {
        if (e.target === this) closeDeleteModal();
      });
      
      // Configurar drag & drop
      setupDragAndDrop();
      
      // Cargar datos iniciales
      loadAllData();
    });

    function setupDragAndDrop() {
      const dropZones = document.querySelectorAll('.drop-zone');
      
      dropZones.forEach(zone => {
        zone.addEventListener('dragover', function(event) {
          event.preventDefault();
          this.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', function(event) {
          this.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', async function(event) {
          event.preventDefault();
          this.classList.remove('drag-over');
          
          if (!draggedTask) return;
          
          // Determinar en qu√© columna se solt√≥
          const columnId = this.parentElement.id;
          let newStatus = '';
          
          if (columnId === 'backlog-col') newStatus = 'backlog';
          else if (columnId === 'doing-col') newStatus = 'doing';
          else if (columnId === 'done-col') newStatus = 'done';
          
          if (newStatus) {
            await moveTask(draggedTask, newStatus);
          }
          
          draggedTask = null;
        });
      });
    }

    // ========== FUNCIONES PRINCIPALES ==========
    async function loadAllData() {
      await loadUsers();
      await loadTasks();
      await loadStats();
    }

    // ========== USUARIOS - CRUD COMPLETO ==========
    async function loadUsers() {
      try {
        const res = await fetch(`${API}/users`);
        if (res.ok) {
          users = await res.json();
          updateUsersList();
          updateAssignSelect(); // ¬°IMPORTANTE! Actualiza el select
        } else {
          console.error("Error en respuesta del servidor:", await res.text());
        }
      } catch (error) {
        console.error("Error cargando usuarios:", error);
        showMessage("Error cargando usuarios", "error");
      }
    }

    async function addUser() {
      const nameInput = document.getElementById('user-name');
      const name = nameInput.value.trim();
      
      if (!name) {
        showMessage("El nombre es obligatorio", "error");
        return;
      }

      try {
        const res = await fetch(`${API}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        });

        if (res.ok) {
          nameInput.value = '';
          // Recargar usuarios para actualizar el select
          await loadUsers();
          showMessage("‚úÖ Usuario agregado correctamente", "success");
        } else {
          const error = await res.json();
          showMessage(error.error || "Error al agregar usuario", "error");
        }
      } catch (error) {
        console.error("Error agregando usuario:", error);
        showMessage("Error de conexi√≥n con el servidor", "error");
      }
    }

    async function updateUser(userId, newName) {
      try {
        const res = await fetch(`${API}/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        });

        if (res.ok) {
          await loadUsers();
          showMessage("‚úÖ Usuario actualizado", "success");
        } else {
          const error = await res.json();
          showMessage(error.error || "Error al actualizar usuario", "error");
        }
      } catch (error) {
        showMessage("Error de conexi√≥n", "error");
      }
    }

    async function deleteUser(userId) {
      try {
        const res = await fetch(`${API}/users/${userId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          // Tambi√©n desasignar este usuario de todas las tareas
          await unassignUserFromAllTasks(userId);
          await loadUsers();
          await loadTasks();
          showMessage("‚úÖ Usuario eliminado", "success");
        } else {
          const error = await res.json();
          showMessage(error.error || "Error al eliminar usuario", "error");
        }
      } catch (error) {
        showMessage("Error de conexi√≥n", "error");
      }
    }

    async function unassignUserFromAllTasks(userId) {
      // Desasignar usuario de todas sus tareas
      const userTasks = tasks.filter(t => t.assigned_to == userId);
      for (const task of userTasks) {
        await updateTask(task.id, 'assigned_to', null);
      }
    }

    function updateUsersList() {
      const container = document.getElementById('users-list');
      if (users.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">No hay usuarios a√∫n</p>';
      } else {
        container.innerHTML = users.map(user => {
          const isEditing = editingUserId === user.id;
          // Contar tareas asignadas a este usuario CORRECTAMENTE
          const taskCount = tasks.filter(t => t.assigned_to == user.id).length;
          
          return `
            <div class="users-list-item">
              <div class="user-info">
                <div class="user-color"></div>
                ${isEditing ? 
                  `<input type="text" class="user-name-edit" value="${user.name}" 
                    onblur="saveUserName(${user.id}, this.value)"
                    onkeypress="if(event.key === 'Enter') this.blur()">` :
                  `<span style="font-weight: bold;">${user.name}</span>`
                }
                <span class="task-count-badge">${taskCount} tarea${taskCount !== 1 ? 's' : ''}</span>
              </div>
              <div class="user-actions">
                ${isEditing ? 
                  `<button class="btn-sm btn-secondary" onclick="cancelEditUser(${user.id})">‚úñ</button>` :
                  `<button class="btn-sm btn-warning" onclick="startEditUser(${user.id})">‚úèÔ∏è</button>`
                }
                <button class="btn-sm btn-danger" onclick="showDeleteUserModal(${user.id}, '${user.name}')">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join('');
        
        // Enfocar input si est√° en modo edici√≥n
        if (editingUserId !== null) {
          const input = container.querySelector('.user-name-edit');
          if (input) {
            input.focus();
            input.select();
          }
        }
      }
    }

    function startEditUser(userId) {
      editingUserId = userId;
      updateUsersList();
    }

    function cancelEditUser() {
      editingUserId = null;
      updateUsersList();
    }

    async function saveUserName(userId, newName) {
      const trimmedName = newName.trim();
      if (!trimmedName) {
        showMessage("El nombre no puede estar vac√≠o", "error");
        editingUserId = null;
        updateUsersList();
        return;
      }
      
      await updateUser(userId, trimmedName);
      editingUserId = null;
    }

    function showDeleteUserModal(userId, userName) {
      userToDelete = userId;
      const taskCount = tasks.filter(t => t.assigned_to == userId).length;
      const message = `¬øEst√°s seguro de eliminar al usuario <strong>"${userName}"</strong>?<br><br>
                      <small style="color: #666;">
                        ${taskCount > 0 ? 
                          `‚ö†Ô∏è Tiene ${taskCount} tarea${taskCount !== 1 ? 's' : ''} asignada${taskCount !== 1 ? 's' : ''}. Quedar√°n sin asignar.` : 
                          'No tiene tareas asignadas.'
                        }
                      </small>`;
      document.getElementById('delete-user-message').innerHTML = message;
      document.getElementById('delete-user-modal').style.display = 'block';
    }

    function closeDeleteModal() {
      document.getElementById('delete-user-modal').style.display = 'none';
      userToDelete = null;
    }

    async function confirmDeleteUser() {
      if (userToDelete) {
        await deleteUser(userToDelete);
        closeDeleteModal();
      }
    }

    function updateAssignSelect() {
      const select = document.getElementById('task-assign');
      if (!select) {
        console.error("No se encontr√≥ el select con id 'task-assign'");
        return;
      }
      
      // Guardar selecci√≥n actual
      const currentSelection = select.value;
      
      // Actualizar opciones
      select.innerHTML = '<option value="">Sin asignar</option>' +
        users.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
      
      // Restaurar selecci√≥n si a√∫n existe
      if (currentSelection && users.some(u => u.id == currentSelection)) {
        select.value = currentSelection;
      }
    }

    function getUserById(id) {
      return users.find(u => u.id == id);
    }

    // ========== TAREAS ==========
    async function loadTasks() {
      try {
        const res = await fetch(`${API}/tasks`);
        if (res.ok) {
          tasks = await res.json();
          renderTasks();
          // Actualizar lista de usuarios para mostrar conteo correcto
          updateUsersList();
        }
      } catch (error) {
        console.error("Error cargando tareas:", error);
      }
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API}/stats`);
        if (res.ok) {
          const stats = await res.json();
          updateStats(stats);
        }
      } catch (error) {
        console.error("Error cargando estad√≠sticas:", error);
      }
    }

    function updateStats(stats) {
      document.getElementById('total-tasks').textContent = stats.total_tasks || 0;
      document.getElementById('doing-count').textContent = `${stats.doing_count || 0}/4`;
      document.getElementById('total-estimated').textContent = stats.doing_estimated || 0;
      document.getElementById('total-real').textContent = stats.done_real || 0;
      
      document.getElementById('doing-tasks-count').textContent = stats.doing_count || 0;
      document.getElementById('doing-total-time').textContent = stats.doing_estimated || 0;
      document.getElementById('done-tasks-count').textContent = stats.done_count || 0;
      document.getElementById('done-total-time').textContent = stats.done_real || 0;
    }

    function renderTasks() {
      renderColumn('backlog-tasks', tasks.filter(t => t.status === 'backlog'));
      renderColumn('doing-tasks', tasks.filter(t => t.status === 'doing'));
      renderColumn('done-tasks', tasks.filter(t => t.status === 'done'));
    }

    function renderColumn(containerId, columnTasks) {
      const container = document.getElementById(containerId);
      if (columnTasks.length === 0) {
        container.innerHTML = '<div class="empty-message">No hay tareas</div>';
      } else {
        container.innerHTML = columnTasks.map(task => createTaskHTML(task)).join('');
        
        // Agregar eventos drag a las nuevas tareas
        columnTasks.forEach(task => {
          const taskElement = document.getElementById(`task-${task.id}`);
          if (taskElement) {
            taskElement.addEventListener('dragstart', function(event) {
              draggedTask = task.id;
              this.classList.add('dragging');
            });
            
            taskElement.addEventListener('dragend', function() {
              this.classList.remove('dragging');
            });
          }
        });
      }
    }

    function createTaskHTML(task) {
      const user = getUserById(task.assigned_to);
      const isEditing = editingTaskId === task.id;
      
      return `
        <div class="task" id="task-${task.id}" draggable="true">
          ${isEditing ? 
            `<input type="text" class="task-title-edit" value="${task.title}" 
              onblur="updateTaskTitle(${task.id}, this.value)"
              onkeypress="if(event.key === 'Enter') this.blur()">` :
            `<div class="task-title" onclick="startEditTitle(${task.id})">
              ${task.title}
            </div>`
          }
          
          <div class="task-info">
            ID: ${task.id} | Estimado: ${task.estimated || 0} min
            ${task.real_time ? `| Real: ${task.real_time} min` : ''}
          </div>
          
          <div style="margin: 5px 0;">
            <small>Asignado a:</small>
            <select class="assign-select" onchange="updateTaskAssignment(${task.id}, this.value)">
              <option value="">Sin asignar</option>
              ${users.map(u => `
                <option value="${u.id}" ${task.assigned_to == u.id ? 'selected' : ''}>
                  ${u.name}
                </option>
              `).join('')}
            </select>
          </div>
          
          ${task.status === 'done' ? `
            <div style="margin-top: 5px;">
              <small>Tiempo real:</small>
              <input type="number" class="time-input" value="${task.real_time || 0}" 
                onchange="updateTask(${task.id}, 'real_time', this.value)"> min
            </div>
          ` : ''}
          
          <div class="task-actions">
            <button class="btn-danger btn-sm" onclick="deleteTask(${task.id})">
              üóëÔ∏è Eliminar
            </button>
          </div>
          
          <div class="task-meta">
            <span>üìÖ ${task.created_at || ''}</span>
            <span>${task.updated_at !== task.created_at ? '‚úèÔ∏è Editada' : ''}</span>
          </div>
        </div>
      `;
    }

    async function updateTaskAssignment(taskId, userId) {
      const assignedTo = userId === "" ? null : parseInt(userId);
      await updateTask(taskId, 'assigned_to', assignedTo);
      // Actualizar lista de usuarios para mostrar nuevo conteo
      updateUsersList();
    }

    async function createTask() {
      const title = document.getElementById('task-title').value.trim();
      const estimated = parseInt(document.getElementById('task-estimated').value) || 0;
      const assignedTo = document.getElementById('task-assign').value || null;

      if (!title) {
        showMessage("El t√≠tulo es obligatorio", "error");
        return;
      }

      try {
        const res = await fetch(`${API}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            title: title, 
            estimated: estimated,
            assigned_to: assignedTo 
          })
        });

        if (res.ok) {
          // Limpiar formulario
          document.getElementById('task-title').value = '';
          document.getElementById('task-estimated').value = '';
          document.getElementById('task-assign').value = '';
          
          // Recargar datos
          await loadTasks();
          await loadStats();
          showMessage("‚úÖ Tarea creada correctamente", "success");
        } else {
          const error = await res.json();
          showMessage(error.error || "Error al crear tarea", "error");
        }
      } catch (error) {
        showMessage("Error de conexi√≥n con el servidor", "error");
      }
    }

    async function moveTask(id, status) {
      try {
        const res = await fetch(`${API}/tasks/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: status })
        });

        if (res.ok) {
          await loadTasks();
          await loadStats();
        } else {
          const error = await res.json();
          showMessage(error.error || "No se puede mover la tarea", "error");
          await loadTasks(); // Recargar para mantener consistencia
        }
      } catch (error) {
        showMessage("Error de conexi√≥n", "error");
        await loadTasks();
      }
    }

    async function updateTask(id, field, value) {
      try {
        const res = await fetch(`${API}/tasks/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });

        if (res.ok) {
          await loadTasks();
          await loadStats();
          // Si cambi√≥ la asignaci√≥n, actualizar lista de usuarios
          if (field === 'assigned_to') {
            updateUsersList();
          }
        }
      } catch (error) {
        console.error("Error actualizando tarea:", error);
      }
    }

    async function startEditTitle(id) {
      editingTaskId = id;
      await loadTasks();
      const input = document.querySelector(`#task-${id} .task-title-edit`);
      if (input) {
        input.focus();
        input.select();
      }
    }

    async function updateTaskTitle(id, newTitle) {
      if (newTitle.trim()) {
        await updateTask(id, 'title', newTitle.trim());
      }
      editingTaskId = null;
      await loadTasks();
    }

    async function deleteTask(id) {
      const task = tasks.find(t => t.id === id);
      const taskTitle = task ? `"${task.title}"` : "esta tarea";
      
      if (!confirm(`¬øEst√°s seguro de eliminar ${taskTitle}?\nEsta acci√≥n no se puede deshacer.`)) {
        return;
      }

      try {
        const res = await fetch(`${API}/tasks/${id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          await loadTasks();
          await loadStats();
          showMessage("‚úÖ Tarea eliminada correctamente", "success");
        }
      } catch (error) {
        showMessage("Error al eliminar tarea", "error");
      }
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
      
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>